# Deployment

## Agenda
- Why deployment
- General concepts
- Deploying scheduler-api to heroku
- Deploying scheduler-react to netlify
- Hot tips
- Not covered - CI/CD
  + CI (Continuous Integration)

## Why deployment

- we are *packaging* our code and *uploading* it, to be run in another *environment* on the cloud (another machine)


## General concepts

- **Resources** for code to sucessfully run in another environment; we need similar *resources* as we have in our local environment. E.g. Database
  + similar to traveling; you pack your clothes (code) but not your house? - you don't take it along with you.

- **Environment Variables** are used to make our code adaptable to multiple environments.
  + they can be used to locate particular resources e.g. database url, blob (media) storage
  + they can be used to make environment based code decisions e.g. sending email; seeding the database

- **Hosting Platform** is the cloud platform, you upload your code to and then run your code on/with. Example Heroku, Netlify

## Deploying scheduler api to Heroku

### GUI Approach

- signup (with Github) / login to heroku.com
- click New; select Create new app
- under deployment method; click Github
- connect to the right git repo

- under *Automatic deploy*, select branch to deploy. Typically it's `master`
- click the `Enable Automatic deploy` button

- under *Manual deploys*, click on `Deploy Branch` to deploy now; the current code in github's master branch of your repo
- wait for deploy to finish
- click View to see deployed app running
  + 'Cannot GET /'

- let's view the logs
- does that error make sense?

- **Lets add Postgres database**
+ under `Resources` search for 'postgres' in the 'Add-ons' and select HerokuPostgres
+ click through to Provision the database.

- Seeding (scheduler-api specific)
We talked about three ways to achieve this:

  1. Set an NODE_ENV variable to 'development' on heroku, and then go to `<your heroku app url/api/debug/reset`

  2. Use the DATABASE_URL from heroku to replace the on in your local .env.development file. That way when you start the locally, you're connecting to the remote (heroku provisioned) database. Then you could go to `localhost:8001/api/debug/reset` as before.

  3. Use your local `psql` and the crendentials from the DATABASE_URL you get on heroku to connect to the remote database.
  Postgres url (connection string) follows the format:
  ```
  postgres://username:password@host:port/databaseName
  ```

  For example if the database url on heroku looks like:

  ```
  postgres://mxrfhqqkmhrxc:ce23e4325f010629290fdfd2828b4fa96a09d274e2f53ff5d242085d5de@ec2-54-17-234-29.compute-1.amazonaws.com:5432/d9a02p9m9d3p
  ```

  The extractable credentials are:
  
  ```
  username      => mxrfhqqkmhrxc
  password      => ce23e4325f010629290fdfd2828b4fa96a09d274e2f53ff5d242085d5de
  host          => ec2-54-17-234-29.compute-1.amazonaws.com
  port          => 5432
  database name => d9a02p9m9d3p
  ```

  Therefore we could use `psql` to connect like so:

  ```
  psql -h ec2-54-17-234-29.compute-1.amazonaws.com -U mxrfhqqkmhrxc -p 5432 -d d9a02p9m9d3p
  ```

  When asked for password, we paste this: `ce23e4325f010629290fdfd2828b4fa96a09d274e2f53ff5d242085d5de`



## Deploying scheduler gui to Netlify


- Signup / Login with your GitHub account
- Click on New site from git
  + choose Github
  + pick a repo

**Two choices*

GUI
- click on Advance Build Settings
  + add environment variables

Configuration File
- create a `netlify.toml` at the root of project

A simple `netlify.toml` config file for our scheduler deployment looks like:

```toml
# Settings in the [build] context are global and are applied to all contexts 
# unless otherwise overridden by more specific contexts.  
[build]
  # Directory to change to before starting a build. 
  # This is where we will look for package.json/.nvmrc/etc.
  base = "/"

  # Directory (relative to root of your repo) that contains the deploy-ready 
  # HTML files and assets generated by the build. If a base directory has
  # been specified, include it in the publish directory path.
  publish = "build/"

  # Default build command.
  command = "npm run build"

[build.environment]
  REACT_APP_API_BASE_URL = "https://scheduler-api-a.herokuapp.com/"
  REACT_APP_WEBSOCKET_URL = "wss://scheduler-api-a.herokuapp.com/"
```


## General deployment tips
  - don't be afraid to delete `node_modules` and `package-lock.json`. DO NOT DELETE `package.json`!
  - reset cache when changes are not being reflected; especially true for GUI deployment e.g on Netlify, AWS S3, AWS Cloudfront, Akamai Cloud
  - don't forget to set your environment variables
  - remember to attach any required resource e.g. Heroku Postgres
  - don't save it for last on a Friday; it could ruin a weekend :)


## Alternatives?
  - Digital Ocean: more manual (surgicalü§∑‚Äç‚ôÇÔ∏è) setup e.g. setup `nginx / apache`, load balancers, firewalls etc
  - AWS EC2
  - AWS S3 (for React gui)
  - GCP (Google Cloud Platform)
  - Azure
  - Your basement Raspberriy Pi??